@using static Entity.Enums.Enum
@model IEnumerable<OnlineAdmissionPortal.Models.UserModel>
@inject IConfiguration _config

<div class="container my-4" ng-controller="userCtrl">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-primary"><i class="fa-solid fa-users"></i> Users</h2>
        <a asp-area="Identity" asp-page="/Account/Register" class="btn btn-primary">
            <i class="fa-solid fa-user-plus"></i> Add User
        </a>
    </div>

    <!-- Filters -->
    <div class="card p-3 mb-4">
        <form class="row g-3" ng-submit="userFilter.currentPage=1;getUsers(userFilter)">
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                    @Html.TextBox("FirstName", "", new { @placeholder = "First Name", @ng_model = "userFilter.FirstName", @class = "form-control", @ng_keyup = "userFilter.currentPage=1;getUsers(userFilter)" })
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-at"></i></span>
                    @Html.TextBox("UserName", "", new { @placeholder = "User Name", @ng_model = "userFilter.UserName", @class = "form-control", @ng_keyup = "userFilter.currentPage=1;getUsers(userFilter)" })
                </div>
            </div>
            <div class="col-md-3">
                <select ng-model="userFilter.RoleName" class="form-select" ng-change="userFilter.currentPage=1;getUsers(userFilter)">
                    <option value="" disabled selected hidden>Select Role</option>
                    @foreach (var item in Html.GetEnumSelectList<Role>())
                    {
                        <option value="@item.Text.ToString()">@item.Text.ToString()</option>
                    }
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-primary me-2" ng-click="userFilter.currentPage=1;getUsers(userFilter)">
                    <i class="fa-solid fa-search"></i> Search
                </button>
                <button type="button" class="btn btn-outline-danger" ng-click="userFilter.currentPage=1;clearFilter(userFilter)">
                    <i class="fa-solid fa-xmark"></i> Clear
                </button>
            </div>
        </form>
    </div>

    <!-- Users Listing -->
    <div class="container mt-4">
        <h2 class="text-center">User Information</h2>
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="user in userList track by $index">
                    <td>{{$index + 1}}</td>
                    <td>{{user.firstName}}</td>
                    <td>{{user.lastName}}</td>
                    <td>{{user.userName}}</td>
                    <td>{{user.roleName}}</td>
                    <td>
                        <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editMember" ng-click="userEdit(user)" ng-show="user.userName != '@User.Identity?.Name'">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteMember" ng-click="userDelete(user)" ng-show="user.userName != '@User.Identity?.Name'">
                            <i class="fa fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                <tr ng-if="!userList || userList.length === 0">
                    <td colspan="6" class="text-center text-muted">No users found.</td>
                </tr>
            </tbody>
        </table>
    </div>


    <!-- Pagination -->
    <div class="mt-4 d-flex justify-content-center">
        <div paging
             page="page"
             page-size="pageSize"
             total="total"
             text-next="Next"
             text-prev="Prev"
             show-prev-next="true"
             show-first-last="false"
             paging-action="userFilter.currentPage=page;userFilter.pageSize=pageSize;getUsers(userFilter);">
        </div>
    </div>
</div>

<!-- Update User Modal -->
<div class="modal fade" id="editMember" tabindex="-1" aria-labelledby="editMemberLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMemberLabel">Update User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form ng-submit="updateUser(userDetails)">
                    <div class="mb-3">
                        <label for="editFirstName" class="form-label">First Name</label>
                        <input ng-model="userDetails.firstName" name="firstName" class="form-control" maxlength="20" ng-pattern="validationConstants.onlyText" required />
                        <span class="text-danger" ng-if="editForm.firstName.$error.required"> First Name is Required! </span>
                        <span class="text-danger" ng-if="editForm.firstName.$dirty&&editForm.firstName.$error.pattern">Please Enter Valid First Name</span>
                    </div>
                    <div class="mb-3">
                        <label for="editLastName" class="form-label">Last Name</label>
                        <input ng-model="userDetails.lastName" name="firstName" class="form-control" maxlength="20" ng-pattern="validationConstants.onlyText" required />
                        <span class="text-danger" ng-if="editForm.lastName.$error.lastName"> First Name is Required! </span>
                        <span class="text-danger" ng-if="editForm.lastName.$dirty&&editForm.lastName.$error.pattern">Please Enter Valid First Name</span>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">Role</label>
                        <select class="form-select" id="editRole" ng-model="userDetails.roleName" required>
                            <option value="" disabled>Select Role</option>
                            @foreach (var item in Html.GetEnumSelectList<Role>())
                            {
                                <option value="@item.Text">@item.Text</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteMember" tabindex="-1" aria-labelledby="deleteMemberLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMemberLabel">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong ng-bind="resUser.firstName + ' ' + resUser.lastName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" ng-click="deleteUser(resUser.userId)" data-bs-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>


<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
